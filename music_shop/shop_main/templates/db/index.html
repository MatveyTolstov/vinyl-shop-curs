{% extends "base.html" %} {% load static %} {% block content %}
<link rel="stylesheet" href="{% static 'main.css' %}" />
<link rel="stylesheet" href="{% static 'tables.css' %}" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% csrf_token %}

<div
	class="product-page"
	style="max-width: 1600px; margin: 100px auto 40px; padding: 0 16px"
>
	<div
		style="
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 20px;
		"
	>
		<h1 class="product-title" style="margin: 0">
			{% if is_manager and not is_staff %} Управление продуктами {% else %}
			Управление базой данных {% endif %}
		</h1>
		<div style="display: flex; gap: 10px">
			<a
				href="{% url 'log-list' %}"
				class="add-to-cart-btn btn-outline"
				style="margin-left: 20px"
			>
				Просмотр логов
			</a>
			<a
				href="{% url 'pdf-report' %}"
				class="add-to-cart-btn"
				style="margin-left: 20px"
			>
				Скачать PDF отчет
			</a>
		</div>
	</div>
	{% if is_manager %}
	<div
		style="
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
			gap: 16px;
			margin-bottom: 24px;
		"
	>
		<div
			class="card"
			style="
				padding: 20px;
				border-radius: 12px;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: white;
			"
		>
			<h3
				style="margin-top: 0; margin-bottom: 8px; font-size: 14px; opacity: 0.9"
			>
				Общая выручка
			</h3>
			<p style="margin: 0; font-size: 32px; font-weight: bold">
				{{ total_revenue|floatformat:0 }} ₽
			</p>
		</div>

		<div
			class="card"
			style="
				padding: 20px;
				border-radius: 12px;
				background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
				color: white;
			"
		>
			<h3
				style="margin-top: 0; margin-bottom: 8px; font-size: 14px; opacity: 0.9"
			>
				Заказов
			</h3>
			<p style="margin: 0; font-size: 32px; font-weight: bold">
				{{ total_orders }}
			</p>
		</div>

		<div
			class="card"
			style="
				padding: 20px;
				border-radius: 12px;
				background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
				color: white;
			"
		>
			<h3
				style="margin-top: 0; margin-bottom: 8px; font-size: 14px; opacity: 0.9"
			>
				Товаров
			</h3>
			<p style="margin: 0; font-size: 32px; font-weight: bold">
				{{ total_products }}
			</p>
		</div>

		<div
			class="card"
			style="
				padding: 20px;
				border-radius: 12px;
				background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
				color: white;
			"
		>
			<h3
				style="margin-top: 0; margin-bottom: 8px; font-size: 14px; opacity: 0.9"
			>
				Клиентов
			</h3>
			<p style="margin: 0; font-size: 32px; font-weight: bold">
				{{ total_customers }}
			</p>
		</div>
	</div>

	<div
		style="
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 24px;
			margin-bottom: 24px;
		"
	>
		<div class="card" style="padding: 20px; border-radius: 12px">
			<h2 style="margin-top: 0; margin-bottom: 20px">Товары по жанрам</h2>
			<div style="height: 300px; position: relative">
				<canvas id="genreChart"></canvas>
			</div>
		</div>

		<div class="card" style="padding: 20px; border-radius: 12px">
			<h2 style="margin-top: 0; margin-bottom: 20px">Популярные товары</h2>
			<div style="height: 300px; position: relative">
				<canvas id="productChart"></canvas>
			</div>
		</div>
	</div>

	{% if popular_products %}
	<div
		class="card"
		style="padding: 20px; border-radius: 12px; margin-bottom: 24px"
	>
		<h2 style="margin-top: 0; margin-bottom: 20px">Топ продаж</h2>
		<table class="table">
			<thead>
				<tr>
					<th>Товар</th>
					<th style="text-align: right">Продано</th>
				</tr>
			</thead>
			<tbody>
				{% for product in popular_products %}
				<tr>
					<td><strong>{{ product.product__product_name }}</strong></td>
					<td style="text-align: right">
						<span class="badge bg-success">{{ product.total_sold }}</span>
					</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
	{% endif %} {% endif %}

	<div
		class="card"
		style="padding: 20px; border-radius: 12px; margin-bottom: 24px"
	>
		<h2
			style="
				margin-top: 0;
				margin-bottom: 20px;
				display: flex;
				justify-content: space-between;
				align-items: center;
			"
		>
			<span>Жанры</span>
			<a
				class="add-to-cart-btn"
				href="{% url 'genre-create' %}"
				style="font-size: 14px; padding: 8px 16px"
			>
				Добавить
			</a>
		</h2>

		{% if genres %}
		<table class="table">
			<thead>
				<tr>
					<th>ID</th>
					<th>Название</th>
					<th>Описание</th>
					<th style="text-align: right">Действия</th>
				</tr>
			</thead>
			<tbody>
				{% for g in genres %}
				<tr>
					<td>#{{ g.id }}</td>
					<td><strong>{{ g.get_genre_name_display }}</strong></td>
					<td>{{ g.description|truncatewords:15 }}</td>
					<td style="text-align: right">
						<a
							class="add-to-cart-btn btn-outline"
							href="{% url 'genre-update' g.pk %}"
							style="font-size: 12px; padding: 4px 8px"
						>
							Редактировать
						</a>
						<a
							class="add-to-cart-btn btn-danger"
							href="{% url 'genre-delete' g.pk %}"
							style="font-size: 12px; padding: 4px 8px"
						>
							Удалить
						</a>
					</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
		{% else %}
		<p class="muted" style="text-align: center; padding: 40px 0">Нет записей</p>
		{% endif %}
	</div>

	<div
		class="card"
		style="padding: 20px; border-radius: 12px; margin-bottom: 24px"
	>
		<h2
			style="
				margin-top: 0;
				margin-bottom: 20px;
				display: flex;
				justify-content: space-between;
				align-items: center;
			"
		>
			<span>Исполнители</span>
			<a
				class="add-to-cart-btn"
				href="{% url 'artist-create' %}"
				style="font-size: 14px; padding: 8px 16px"
			>
				Добавить
			</a>
		</h2>

		{% if artists %}
		<table class="table">
			<thead>
				<tr>
					<th>ID</th>
					<th>Имя</th>
					<th>Страна</th>
					<th style="text-align: right">Действия</th>
				</tr>
			</thead>
			<tbody>
				{% for a in artists %}
				<tr>
					<td>#{{ a.id }}</td>
					<td><strong>{{ a.artist_name }}</strong></td>
					<td>{{ a.country|default:"—" }}</td>
					<td style="text-align: right">
						<a
							class="add-to-cart-btn btn-outline"
							href="{% url 'artist-update' a.pk %}"
							style="font-size: 12px; padding: 4px 8px"
						>
							Редактировать
						</a>
						<a
							class="add-to-cart-btn btn-danger"
							href="{% url 'artist-delete' a.pk %}"
							style="font-size: 12px; padding: 4px 8px"
						>
							Удалить
						</a>
					</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
		{% else %}
		<p class="muted" style="text-align: center; padding: 40px 0">Нет записей</p>
		{% endif %}
	</div>

	<div
		class="card"
		style="padding: 20px; border-radius: 12px; margin-bottom: 24px"
	>
		<h2
			style="
				margin-top: 0;
				margin-bottom: 20px;
				display: flex;
				justify-content: space-between;
				align-items: center;
			"
		>
			<span>Товары</span>
			<a
				class="add-to-cart-btn"
				href="{% url 'product-create' %}"
				style="font-size: 14px; padding: 8px 16px"
			>
				Добавить
			</a>
		</h2>

		{% if products %}
		<div style="overflow-x: auto">
			<table class="table">
				<thead>
					<tr>
						<th>ID</th>
						<th>Название</th>
						<th>Исполнитель</th>
						<th>Жанр</th>
						<th>Цена</th>
						<th>Остаток</th>
						<th style="text-align: right">Действия</th>
					</tr>
				</thead>
				<tbody>
					{% for p in products %}
					<tr>
						<td>#{{ p.id }}</td>
						<td><strong>{{ p.product_name }}</strong></td>
						<td>{{ p.artist.artist_name }}</td>
						<td>
							<span class="badge bg-secondary"
								>{{ p.genre.get_genre_name_display }}</span
							>
						</td>
						<td>{{ p.price }} ₽</td>
						<td>
							{% if p.stock_quantity > 0 %}
							<span class="badge bg-success">{{ p.stock_quantity }}</span>
							{% else %}
							<span class="badge bg-danger">0</span>
							{% endif %}
						</td>
						<td style="text-align: right">
							<a
								class="add-to-cart-btn btn-outline"
								href="{% url 'product-update' p.pk %}"
								style="font-size: 12px; padding: 4px 8px"
							>
								Редактировать
							</a>
							<a
								class="add-to-cart-btn btn-danger"
								href="{% url 'product-delete' p.pk %}"
								style="font-size: 12px; padding: 4px 8px"
							>
								Удалить
							</a>
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
		{% else %}
		<p class="muted" style="text-align: center; padding: 40px 0">Нет записей</p>
		{% endif %}
	</div>

	{% if show_orders %}
	<div
		class="card"
		style="padding: 20px; border-radius: 12px; margin-bottom: 24px"
	>
		<h2
			style="
				margin-top: 0;
				margin-bottom: 20px;
				display: flex;
				justify-content: space-between;
				align-items: center;
			"
		>
			<span>Заказы</span>
			<a
				class="add-to-cart-btn"
				href="{% url 'order-create' %}"
				style="font-size: 14px; padding: 8px 16px"
			>
				Добавить
			</a>
		</h2>

		{% if orders %}
		<div style="overflow-x: auto">
			<table class="table">
				<thead>
					<tr>
						<th>ID</th>
						<th>Пользователь</th>
						<th>Дата</th>
						<th>Статус</th>
						<th>Сумма</th>
						<th style="text-align: right">Действия</th>
					</tr>
				</thead>
				<tbody>
					{% for o in orders %}
					<tr>
						<td>#{{ o.id }}</td>
						<td>{{ o.user.username }}</td>
						<td>{{ o.date_order|date:"d.m.Y H:i" }}</td>
						<td>{{ o.status }}</td>
						<td>{{ o.get_total|floatformat:0 }} ₽</td>
						<td style="text-align: right">
							{% if show_orders %}
							<a
								class="add-to-cart-btn btn-outline"
								href="{% url 'order-update' o.pk %}"
								style="font-size: 12px; padding: 4px 8px"
							>
								Редактировать
							</a>
							<a
								class="add-to-cart-btn btn-danger"
								href="{% url 'order-delete' o.pk %}"
								style="font-size: 12px; padding: 4px 8px"
							>
								Удалить
							</a>
							{% endif %}
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
		{% else %}
		<p class="muted" style="text-align: center; padding: 40px 0">Нет записей</p>
		{% endif %}
	</div>
	{% endif %} {% if show_all %}
	<div
		class="card"
		style="padding: 20px; border-radius: 12px; margin-bottom: 24px"
	>
		<h2
			style="
				margin-top: 0;
				margin-bottom: 20px;
				display: flex;
				justify-content: space-between;
				align-items: center;
			"
		>
			<span>Отзывы</span>
			<a
				class="add-to-cart-btn"
				href="{% url 'review-create' %}"
				style="font-size: 14px; padding: 8px 16px"
			>
				Добавить
			</a>
		</h2>

		{% if reviews %}
		<div style="overflow-x: auto">
			<table class="table">
				<thead>
					<tr>
						<th>ID</th>
						<th>Товар</th>
						<th>Пользователь</th>
						<th>Оценка</th>
						<th>Текст</th>
						<th style="text-align: right">Действия</th>
					</tr>
				</thead>
				<tbody>
					{% for r in reviews %}
					<tr>
						<td>#{{ r.id }}</td>
						<td>{{ r.product.product_name }}</td>
						<td>{{ r.user.username }}</td>
						<td><span class="badge bg-warning">{{ r.rating }}</span></td>
						<td>{{ r.text|truncatewords:10 }}</td>
						<td style="text-align: right">
							<a
								class="add-to-cart-btn btn-secondary"
								href="{% url 'review-detail' r.pk %}"
								style="font-size: 12px; padding: 4px 8px"
							>
								Просмотр
							</a>
							<a
								class="add-to-cart-btn btn-outline"
								href="{% url 'review-update' r.pk %}"
								style="font-size: 12px; padding: 4px 8px"
							>
								Редактировать
							</a>
							<a
								class="add-to-cart-btn btn-danger"
								href="{% url 'review-delete' r.pk %}"
								style="font-size: 12px; padding: 4px 8px"
							>
								Удалить
							</a>
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
		{% else %}
		<p class="muted" style="text-align: center; padding: 40px 0">Нет записей</p>
		{% endif %}
	</div>
	{% endif %} {% if show_orders %}
	<div
		class="card"
		style="padding: 20px; border-radius: 12px; margin-bottom: 24px"
	>
		<h2
			style="
				margin-top: 0;
				margin-bottom: 20px;
				display: flex;
				justify-content: space-between;
				align-items: center;
			"
		>
			<span>Купоны</span>
			<a
				class="add-to-cart-btn"
				href="{% url 'coupon-create' %}"
				style="font-size: 14px; padding: 8px 16px"
			>
				Добавить
			</a>
		</h2>

		{% if coupons %}
		<table class="table">
			<thead>
				<tr>
					<th>ID</th>
					<th>Код</th>
					<th>Скидка</th>
					<th>Активен</th>
					<th style="text-align: right">Действия</th>
				</tr>
			</thead>
			<tbody>
				{% for c in coupons %}
				<tr>
					<td>#{{ c.id }}</td>
					<td><strong>{{ c.code }}</strong></td>
					<td>{{ c.discount_percent }}%</td>
					<td>
						{% if c.active %}
						<span class="badge bg-success">Да</span>
						{% else %}
						<span class="badge bg-danger">Нет</span>
						{% endif %}
					</td>
					<td style="text-align: right">
						<a
							class="add-to-cart-btn btn-outline"
							href="{% url 'coupon-update' c.pk %}"
							style="font-size: 12px; padding: 4px 8px"
						>
							Редактировать
						</a>
						<a
							class="add-to-cart-btn btn-danger"
							href="{% url 'coupon-delete' c.pk %}"
							style="font-size: 12px; padding: 4px 8px"
						>
							Удалить
						</a>
					</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
		{% else %}
		<p class="muted" style="text-align: center; padding: 40px 0">Нет записей</p>
		{% endif %}
	</div>
	{% endif %}

	<!-- Таблица Пользователи -->
	{% if show_all %}
	<div
		class="card"
		style="padding: 20px; border-radius: 12px; margin-bottom: 24px"
	>
		<h2
			style="
				margin-top: 0;
				margin-bottom: 20px;
				display: flex;
				justify-content: space-between;
				align-items: center;
			"
		>
			<span>Пользователи</span>
		</h2>

		{% if users %}
		<table class="table">
			<thead>
				<tr>
					<th>ID</th>
					<th>Имя пользователя</th>
					<th>Email</th>
					<th>Фамилия</th>
					<th>Имя</th>
					<th>Группы</th>
					<th style="text-align: right">Действия</th>
				</tr>
			</thead>
			<tbody>
				{% for u in users %}
				<tr>
					<td>#{{ u.id }}</td>
					<td><strong>{{ u.username }}</strong></td>
					<td>{{ u.email|default:"—" }}</td>
					<td>{{ u.last_name|default:"—" }}</td>
					<td>{{ u.first_name|default:"—" }}</td>
					<td>
						{% for group in u.groups.all %}
						<span class="badge bg-primary">{{ group.name }}</span>
						{% empty %}
						<span class="badge bg-secondary">Нет ролей</span>
						{% endfor %}
					</td>
					<td style="text-align: right">
						<a
							class="add-to-cart-btn btn-outline"
							href="/admin/auth/user/{{ u.pk }}/change/"
							style="font-size: 12px; padding: 4px 8px"
						>
							Редактировать в админке
						</a>
					</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
		{% else %}
		<p class="muted" style="text-align: center; padding: 40px 0">Нет записей</p>
		{% endif %}
	</div>
	{% endif %} {% if show_all %}
	<div
		class="card"
		style="padding: 20px; border-radius: 12px; margin-bottom: 24px"
	>
		<h2
			style="
				margin-top: 0;
				margin-bottom: 20px;
				display: flex;
				justify-content: space-between;
				align-items: center;
			"
		>
			<span>Роли (Группы)</span>
		</h2>

		{% if groups %}
		<table class="table">
			<thead>
				<tr>
					<th>ID</th>
					<th>Название</th>
					<th>Количество пользователей</th>
					<th style="text-align: right">Действия</th>
				</tr>
			</thead>
			<tbody>
				{% for g in groups %}
				<tr>
					<td>#{{ g.id }}</td>
					<td><strong>{{ g.name }}</strong></td>
					<td>{{ g.user_set.count }}</td>
					<td style="text-align: right">
						<a
							class="add-to-cart-btn btn-outline"
							href="/admin/auth/group/{{ g.pk }}/change/"
							style="font-size: 12px; padding: 4px 8px"
						>
							Редактировать в админке
						</a>
					</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
		{% else %}
		<p class="muted" style="text-align: center; padding: 40px 0">Нет записей</p>
		{% endif %}
	</div>
	{% endif %}
</div>

<style>
	.table-card {
		transition: transform 0.15s ease, box-shadow 0.15s ease;
	}
	.table-card:hover .card {
		transform: translateY(-2px);
		box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
	}

	@keyframes slideIn {
		from {
			transform: translateX(100%);
			opacity: 0;
		}
		to {
			transform: translateX(0);
			opacity: 1;
		}
	}

	@keyframes slideOut {
		from {
			transform: translateX(0);
			opacity: 1;
		}
		to {
			transform: translateX(100%);
			opacity: 0;
		}
	}

	.status-select {
		transition: all 0.2s ease;
	}

	.status-select:hover {
		border-color: #007bff;
		box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
	}
</style>

<script>

	{% if genre_stats %}
	const genreCtx = document.getElementById('genreChart');
	new Chart(genreCtx, {
	    type: 'doughnut',
	    data: {
	        labels: [
	            {% for stat in genre_stats %}
	                '{{ stat.name }}',
	            {% endfor %}
	        ],
	        datasets: [{
	            data: [
	                {% for stat in genre_stats %}
	                    {{ stat.count }},
	                {% endfor %}
	            ],
	            backgroundColor: [
	                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
	            ]
	        }]
	    },
	    options: {
	        responsive: true,
	        maintainAspectRatio: false,
	        plugins: {
	            legend: {
	                position: 'bottom'
	            }
	        }
	    }
	});
	{% endif %}


	{% if popular_products %}
	const productCtx = document.getElementById('productChart');
	new Chart(productCtx, {
	    type: 'bar',
	    data: {
	        labels: [
	            {% for product in popular_products %}
	                '{{ product.product__product_name|truncatewords:3 }}',
	            {% endfor %}
	        ],
	        datasets: [{
	            label: 'Продано',
	            data: [
	                {% for product in popular_products %}
	                    {{ product.total_sold }},
	                {% endfor %}
	            ],
	            backgroundColor: '#4BC0C0'
	        }]
	    },
	    options: {
	        responsive: true,
	        maintainAspectRatio: false,
	        plugins: {
	            legend: {
	                position: 'bottom'
	            }
	        }
	    }
	});
	{% endif %}


	document.addEventListener('DOMContentLoaded', function() {
	    const statusSelects = document.querySelectorAll('.status-select');
	    statusSelects.forEach(select => {
	        select.addEventListener('change', function() {
	            const orderId = this.dataset.orderId;
	            const newStatus = this.value;


	            fetch(`/api/v1/orders/${orderId}/`, {
	                method: 'PATCH',
	                headers: {
	                    'Content-Type': 'application/json',
	                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
	                },
	                body: JSON.stringify({ status: newStatus }),
	                credentials: 'include'
	            })
	            .then(response => {
	                if (response.ok) {

	                    const statusText = this.options[this.selectedIndex].text;
	                    showNotification(`Статус заказа #${orderId} изменен на "${statusText}"`, 'success');
	                } else {
	                    throw new Error('Ошибка обновления статуса');
	                }
	            })
	            .catch(error => {
	                console.error('Ошибка:', error);
	                showNotification('Ошибка при изменении статуса заказа', 'error');

	                this.value = this.dataset.previousValue;
	            });
	        });


	        select.dataset.previousValue = select.value;
	    });
	});

	function showNotification(message, type = 'info') {

	    const notification = document.createElement('div');
	    notification.style.cssText = `
	        position: fixed;
	        top: 20px;
	        right: 20px;
	        padding: 12px 20px;
	        border-radius: 8px;
	        color: white;
	        font-weight: bold;
	        z-index: 1000;
	        animation: slideIn 0.3s ease-out;
	    `;

	    if (type === 'success') {
	        notification.style.backgroundColor = '#28a745';
	    } else if (type === 'error') {
	        notification.style.backgroundColor = '#dc3545';
	    } else {
	        notification.style.backgroundColor = '#17a2b8';
	    }

	    notification.textContent = message;
	    document.body.appendChild(notification);


	    setTimeout(() => {
	        notification.style.animation = 'slideOut 0.3s ease-in';
	        setTimeout(() => {
	            document.body.removeChild(notification);
	        }, 300);
	    }, 3000);
	}
</script>
{% endblock %}
